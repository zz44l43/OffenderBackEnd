<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml">
<head th:replace="fragments/header :: header('Login')" />
<body>
<div id="root">
    <div th:replace="fragments/nav :: nav"></div>
    <div class="container">
        <div class="row">
            <table class="table table-condensed">
                <thead>
                <tr>
                    <th>Select</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Email</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td><div><input type="checkbox" id="checkbox1" class="styled"></input></div></td>
                    <td>John</td>
                    <td>Carter</td>
                    <td>johncarter@mail.com</td>
                </tr>
                <tr>
                    <td><div><input type="checkbox" id="checkbox2" class="styled"></input></div></td>
                    <td>Peter</td>
                    <td>Parker</td>
                    <td>peterparker@mail.com</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
<div th:replace="fragments/footer :: foot"></div>
<script>
    var app = new Vue({
        el: '#root',
        mounted() {
            this.isLoggedIn();
            this.reset();
            this.fetchExistingUpload();
        },
        data:{
            STATUS_INITIAL: 0,
            STATUS_SAVING : 1,
            STATUS_SUCCESS : 2,
            STATUS_FAILED : 3,
            uploadedFiles: [],
            uploadError: null,
            currentStatus: null,
            uploadFieldName: 'file',
            justUploadedFiles: []
        },
        computed: {
            isInitial() {
                return this.currentStatus === this.STATUS_INITIAL;
                },
            isSaving() {
                return this.currentStatus === this.STATUS_SAVING;
            },
            isSuccess() {
                return this.currentStatus === this.STATUS_SUCCESS;
            },
            isFailed() {
                return this.currentStatus === this.STATUS_FAILED;
            }
    },
        methods: {
            isLoggedIn(){
                if(getCookie("access_token")){
                    axios.get("/getUsername?access_token=" + getCookie("access_token"))
                        .then(function(response){
                            return true;
                        })
                        .catch(function(error){
                            document.location.replace("/login");
                        });
                 }
                 else{
                         document.location.replace("/login");
                    }
            },
            reset() {
                this.currentStatus = this.STATUS_INITIAL;
                this.uploadError = null;
                this.justUploadedFiles = [];
            },
             save(formData) {
                this.currentStatus = this.STATUS_SAVING;
                this.upload(formData);
            },
            fetchExistingAttributes(){
                    axios.get("/api/attributes/" + getCookie("username")).then(function(response){
                    this.attributes = [];
                    this.attributes = response.data;

                }.bind(this));
            },
            fetchExistingUpload(){
                axios.get("/api/fetchUpload/" + getCookie("username")).then(function(response){
                    this.uploadedFiles = [];
                    this.uploadedFiles = response.data;
                    this.uploadedFiles = _.sortBy(this.uploadedFiles,function(file){ return -file.dateCreated; })
                }.bind(this));
            },
            upload(formData){
                axios({
                        method:'post',
                        url:'api/upload?access_token=' + getCookie("access_token"),
                        auth:{username:'my-trusted-client',password:'secret'},
                        headers: {"Content-type": "multipart/form-data"},
                        data:formData
                    }) .then(x => {
                        this.currentStatus = this.STATUS_SUCCESS;
                        this.justUploadedFiles = [].concat(x);
                        this.fetchExistingUpload();
                    })
                    .catch(err => {
                        this.uploadError = err.response;
                        this.currentStatus = this.STATUS_FAILED;
                    });
            },
           filesChange(fieldName, fileList) {
            const formData = new FormData();
            if (!fileList.length) return;
            Array.from(Array(fileList.length).keys()).map(x => {
                formData.append(fieldName, fileList[x], fileList[x].name);
            });
            this.save(formData);
            }
        }
    });
</script>
</html>